# QA-019D — Flake-Proof KWS E2E + Rich Artifacts

**Goal:** Make the loopback job bulletproof and highly debuggable by adding retries, stricter readiness checks, and uploading diagnostics on failure.

## Why
Occasional CI runner timing variance can cause timeouts. Rich artifacts + controlled retries reduce false reds and speed up root cause analysis.

## Deliverables

### 1. Stability Improvements
- **Pre-flight readiness**: Assert PipeWire/WirePlumber are up (retry-with-backoff)
- **Wait-until**: Confirm `qa_sink` sink exists via `pactl list short sinks | grep QA_SINK`
- **Extend test window**: Arm window to 10s (configurable via env `EMB_TEST_WINDOW_MS`)
- **Single retry**: Retry once on timeout (exit code 1); cap at 1 retry total
- **Total job budget**: Maintain 8-minute timeout (currently ~3-4 min nominal)

### 2. Rich Artifacts on Failure
Upload the following on job failure (7-day retention):
- **PipeWire state**:
  - `pw-cli dump` output
  - `pw-cli ls` output
- **PulseAudio/PipeWire info**:
  - `pactl info`
  - `pactl list sinks`
  - `pactl list sources`
- **Harness output**:
  - Full stdout/stderr from harness
  - Structured JSON logs (if `--json` mode implemented)
- **App logs** (if produced):
  - Tauri application logs
  - KWS worker logs
- **Future** (optional):
  - WebView screenshot on failure

### 3. Observability & Structured Logs
- Add `--json` flag to harness for structured output
- Emit timestamps:
  - `armed_at`: When test window was armed
  - `timeout_at`: When window expires
  - `detected_at`: When wake word detected
- Include timings:
  - Model download duration
  - Verification duration
  - Total test duration

### 4. Documentation Updates
Update `docs/QA-019-KWS-Smoke.md`:
- **"Flake Handling"** section:
  - Retry strategy
  - Readiness checks
  - When to consider it a real failure
- **"Artifacts to Inspect"** checklist:
  - What each artifact tells you
  - Common patterns in failed runs
  - Example triage workflow
- **Example failure triage script**:
  - Script to download and analyze artifacts locally

## Acceptance Criteria
- ✅ Job passes consistently on 3 consecutive runs on clean main
- ✅ On induced failure (muted sink), artifacts include all PipeWire and pactl snapshots
- ✅ Max one automatic retry only on timeout (exit code 1), not on errors (exit code 2)
- ✅ Total runtime ≤ 6 minutes (includes retry if needed)
- ✅ Artifacts uploaded and accessible for 7 days
- ✅ Harness `--json` mode produces valid JSONL output

## Implementation Sketch

### CI Job Enhancements

```yaml
  - name: Verify PipeWire readiness
    run: |
      set -e
      echo "Waiting for PipeWire services..."
      for i in 1 2 3 4 5; do
        if pgrep -x pipewire && pgrep -x wireplumber; then
          echo "✓ PipeWire and WirePlumber running"
          break
        fi
        if [ $i -eq 5 ]; then
          echo "✗ Timeout waiting for PipeWire services"
          exit 1
        fi
        echo "Waiting... ($i/5)"
        sleep 1
      done

  - name: Verify audio graph ready
    run: |
      set -e
      echo "Waiting for qa_sink..."
      for i in 1 2 3 4 5; do
        if pactl list short sinks | grep -q QA_SINK; then
          echo "✓ QA_SINK ready"
          exit 0
        fi
        if [ $i -eq 5 ]; then
          echo "✗ QA_SINK not found after 5 attempts"
          pactl list short sinks || true
          exit 1
        fi
        echo "Waiting... ($i/5)"
        sleep 1
      done

  - name: Run E2E harness (attempt 1)
    id: attempt1
    continue-on-error: true
    env:
      EMB_LOOPBACK: "1"
      EMB_TEST_WINDOW_MS: "10000"
    run: |
      xvfb-run -a node scripts/qa/run-kws-e2e.mjs --json > harness.jsonl 2>&1
      echo "exit_code=$?" >> $GITHUB_OUTPUT

  - name: Retry on timeout (attempt 2)
    id: attempt2
    if: steps.attempt1.outputs.exit_code == '1'
    env:
      EMB_LOOPBACK: "1"
      EMB_TEST_WINDOW_MS: "10000"
    run: |
      echo "⚠️  First attempt timed out, retrying once..."
      xvfb-run -a node scripts/qa/run-kws-e2e.mjs --json >> harness.jsonl 2>&1

  - name: Collect diagnostics on failure
    if: failure()
    run: |
      echo "Collecting PipeWire diagnostics..."
      pw-cli ls > pw-cli-ls.txt 2>&1 || echo "pw-cli ls failed" > pw-cli-ls.txt
      pw-cli dump > pw-cli-dump.txt 2>&1 || echo "pw-cli dump failed" > pw-cli-dump.txt
      pactl info > pactl-info.txt 2>&1 || echo "pactl info failed" > pactl-info.txt
      pactl list sinks > pactl-sinks.txt 2>&1 || echo "pactl list sinks failed" > pactl-sinks.txt
      pactl list sources > pactl-sources.txt 2>&1 || echo "pactl list sources failed" > pactl-sources.txt
      echo "Diagnostics collected"

  - name: Upload artifacts on failure
    if: failure()
    uses: actions/upload-artifact@v4
    with:
      name: qa-kws-e2e-failure-diagnostics
      path: |
        harness.jsonl
        pw-cli-*.txt
        pactl-*.txt
      retention-days: 7
      if-no-files-found: warn
```

### Harness `--json` Mode (Stub)

Add to `scripts/qa/run-kws-e2e.mjs`:

```javascript
const JSON_MODE = process.argv.includes('--json');

function logJson(event, data) {
  if (JSON_MODE) {
    console.log(JSON.stringify({ ts: Date.now(), event, ...data }));
  }
}

// Usage:
logJson('armed', { duration_ms: 10000, armed_at: Date.now() });
logJson('detected', { keyword: 'hey ember', detected_at: Date.now() });
logJson('timeout', { timeout_at: Date.now() });
```

## Triage Workflow Example

When a job fails:

1. **Download artifacts**:
   ```bash
   gh run download <run_id> -n qa-kws-e2e-failure-diagnostics
   ```

2. **Check PipeWire state**:
   ```bash
   # Did PipeWire start?
   grep -i "error\|fail" pw-cli-ls.txt

   # Was qa_sink created?
   grep -i "QA_SINK" pactl-sinks.txt
   ```

3. **Check harness logs**:
   ```bash
   # For JSON mode
   jq -r '.event' harness.jsonl | sort | uniq -c

   # For plain logs
   grep -i "error\|timeout\|fail" harness.jsonl
   ```

4. **Common failure patterns**:
   - **No qa_sink**: Loopback module failed to load
   - **Timeout on first run**: Network slow (model download)
   - **Timeout on retry**: Real detection failure or app crash
   - **Error (exit 2)**: Harness infrastructure issue

## Security Considerations
- Artifacts may contain audio pipeline state but no audio samples
- No secrets or credentials in harness output
- 7-day retention limits exposure window

## Future Enhancements
- **WebView screenshot**: Capture app state on failure (requires headless screenshot capability)
- **Model caching**: Cache downloaded models across runs (reduces retry latency)
- **Parallel model preload**: Download model in parallel with build step
- **Metrics**: Track success rate, P50/P95/P99 latency over time

## References
- [QA-019-KWS-Smoke.md](../QA-019-KWS-Smoke.md) — Manual and automated testing guide
- [QA-019C ticket](./QA-019C.md) — Original loopback CI job
- GitHub Actions: [Upload artifacts](https://github.com/actions/upload-artifact)
